import e from"axios";function t(e){return parseFloat(e.replace(",",".").replace("€","").trim())}function n(e,t=" à "){const[n,o]=e.split(t),[a,r,s]=n.split("/"),[i,c]=o.split(":");return new Date(parseInt(s),parseInt(r)-1,parseInt(a),parseInt(i),parseInt(c))}function o(e,t){const n=new RegExp(`<${t}[^>]*>(.*?)</${t}>`,"s"),o=e.match(n);return o?o[1].trim():""}function a(e,t,n=0){const o=new RegExp(`<[^>]*class=[^>]*${t}[^>]*>(.*?)</`,"g"),a=[...e.matchAll(o)];return a[n]?a[n][1].trim():""}function r(e,t){const n=new RegExp(`<[^>]*id="${t}"[^>]*>(.*?)</`,"s"),o=e.match(n);return o?o[1].trim():""}var s=class{axiosInstance;cookies;constructor(){this.axiosInstance=e.create({withCredentials:!0,maxRedirects:0,validateStatus:()=>!0,headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","Accept-Language":"fr-FR,fr;q=0.9,en-GB;q=0.8,en;q=0.7,en-US;q=0.6,es;q=0.5"}}),this.cookies=[]}updateCookies(e){if(e["set-cookie"]){const t=Array.isArray(e["set-cookie"])?e["set-cookie"]:[e["set-cookie"]];this.cookies=[...this.cookies,...t],this.axiosInstance.defaults.headers.Cookie=this.cookies.join("; ")}}async makeRequest(e,t,n=null,o={}){const a={method:e,url:t,headers:{...this.axiosInstance.defaults.headers,...o},data:n};this.cookies.length>0&&(a.headers=a.headers||{},a.headers.Cookie=this.cookies.join("; "));const r=await this.axiosInstance(a);return this.updateCookies(r.headers),r}async login(e,t){try{let n=await this.makeRequest("GET","https://mon-espace.izly.fr/Home/Logon",null,{Referer:"https://mon-espace.izly.fr/"});const o=function(e){const t=e.match(/<input[^>]*name=["']__RequestVerificationToken["'][^>]*value=["']([^"']+)["'][^>]*>/i);return t?t[1]:""}(n.data);if(!o)throw new Error("Failed to extract request verification token");if(n=await this.makeRequest("POST","https://mon-espace.izly.fr/Home/Logon",`__RequestVerificationToken=${encodeURIComponent(o)}&ReturnUrl=&Username=${encodeURIComponent(e)}&Password=${encodeURIComponent(t)}`,{"Content-Type":"application/x-www-form-urlencoded",Origin:"https://mon-espace.izly.fr",Referer:"https://mon-espace.izly.fr/Home/Logon"}),302===n.status){const e=n.headers.location;n=await this.makeRequest("GET",`https://mon-espace.izly.fr${e}`,null,{Referer:"https://mon-espace.izly.fr/Home/Logon"})}if(n=await this.makeRequest("GET","https://mon-espace.izly.fr/",null,{Referer:"https://mon-espace.izly.fr/Home/Logon"}),200!==n.status)throw new Error("Failed to login");return!0}catch(e){return console.error("Login error:",e.message),!1}}getAxiosInstance(){return this.axiosInstance}},i=class{loginService;axiosInstance;loggedIn=!1;constructor(){this.loginService=new s,this.axiosInstance=this.loginService.getAxiosInstance()}async login(e,t){try{return this.loggedIn=await this.loginService.login(e,t),this.loggedIn}catch(e){return console.error("Login error:",e.message),!1}}checkLogin(){if(!this.loggedIn)throw new Error("Not logged in. Please login first.")}async getProfile(){return this.checkLogin(),async function(e){try{const t=await e.get("https://mon-espace.izly.fr/Profile",{headers:{Referer:"https://mon-espace.izly.fr/"}});if(200===t.status){const e=t.data;return{name:o(e,"h1"),identifier:a(e,"heading-label-value",0),pseudo:a(e,"heading-label-value",1),birthDate:a(e,"heading-label-value",2),address:`${a(e,"addWay")}, ${a(e,"addZipCode")} ${a(e,"addCity")}`,primaryEmail:a(e,"rectangle",1),secondaryEmail:r(e,"emailPersonnel"),phoneNumber:r(e,"currentPhoneNumber"),companyCode:a(e,"rectangle",4),tariffCode:a(e,"rectangle",5),crousRightsEndDate:a(e,"rectangle",6)}}throw new Error("Failed to retrieve profile information")}catch(e){throw console.error("Error retrieving profile information:",e.message),e}}(this.axiosInstance)}async getNotifications(){return this.checkLogin(),async function(e){try{const t=await e.get("https://mon-espace.izly.fr/Profile?page=1",{headers:{Accept:"text/html, */*; q=0.01","X-Requested-With":"XMLHttpRequest",Referer:"https://mon-espace.izly.fr/Profile"}});if(200===t.status){const e=t.data,o=[];return(e.match(/<tr>[\s\S]*?<\/tr>/g)||[]).forEach((e=>{const t=function(e){return[...e.matchAll(/<td[^>]*>([\s\S]*?)<\/td>/g)].map((e=>e[1].replace(/<[^>]*>/g,"").trim()))}(e);if(t.length>=3){const e=n(t[1]," à "),a=t[2];o.push({date:e,description:a})}})),o}throw new Error("Failed to retrieve notifications")}catch(e){throw console.error("Error retrieving notifications:",e.message),e}}(this.axiosInstance)}async getBalance(){return this.checkLogin(),async function(e){const o=(await e.get("https://mon-espace.izly.fr/",{headers:{Referer:"https://mon-espace.izly.fr/Home/Logon"}})).data,s=t(r(o,"balance")),i=n(a(o,"balance-heading-date")," à ");if(isNaN(s))throw new Error("Failed to extract balance. Possible page structure change.");return{date:i,amount:s}}(this.axiosInstance)}async getDeposits(){return this.checkLogin(),async function(e){const o=(await e.get("https://mon-espace.izly.fr/Home/GetTopups",{headers:{Referer:"https://mon-espace.izly.fr/","X-Requested-With":"XMLHttpRequest"}})).data,r=[];return(o.match(/<li class="list-group-item"[^>]*>[\s\S]*?<\/li>/g)||[]).forEach((e=>{const o=a(e,"operation-type"),[s,i]=o.split(" - ").map((e=>e.trim())),c=n(a(e,"oeration-date")," "),l=t(a(e,"operation-amount")),h=a(e,"badge");r.push({type:s,method:i,date:c,amount:l,status:h})})),r}(this.axiosInstance)}async generateQRCode(){return this.checkLogin(),async function(e,t=1){try{const n=await e.post("https://mon-espace.izly.fr/Home/CreateQrCodeImg",`numberOfQrCodes=${t}`,{headers:{Accept:"text/html, */*; q=0.01","X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Origin:"https://mon-espace.izly.fr",Referer:"https://mon-espace.izly.fr/Home/GenerateQRCode"}});if(200===n.status)return n.data;throw new Error("Failed to generate QR Code(s)")}catch(e){throw console.error("Error generating QR Code(s):",e.message),e}}(this.axiosInstance)}};export{i as default};//# sourceMappingURL=index.mjs.map