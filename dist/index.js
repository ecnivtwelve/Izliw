"use strict";var e=require("cheerio"),t=require("axios");function r(e){return e&&e.__esModule?e:{default:e}}function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var n=i(e),a=r(t);function o(e){return parseFloat(e.replace(",",".").replace("€","").trim())}function s(e,t=" à "){const[r,i]=e.split(t),[n,a,o]=r.split("/"),[s,c]=i.split(":");return new Date(parseInt(o),parseInt(a)-1,parseInt(n),parseInt(s),parseInt(c))}var c=class{axiosInstance;cookies;constructor(){this.axiosInstance=a.default.create({withCredentials:!0,maxRedirects:0,validateStatus:()=>!0,headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","Accept-Language":"fr-FR,fr;q=0.9,en-GB;q=0.8,en;q=0.7,en-US;q=0.6,es;q=0.5"}}),this.cookies=[]}updateCookies(e){if(e["set-cookie"]){const t=Array.isArray(e["set-cookie"])?e["set-cookie"]:[e["set-cookie"]];this.cookies=[...this.cookies,...t],this.axiosInstance.defaults.headers.Cookie=this.cookies.join("; ")}}async makeRequest(e,t,r=null,i={}){const n={method:e,url:t,headers:{...this.axiosInstance.defaults.headers,...i},data:r};this.cookies.length>0&&(n.headers=n.headers||{},n.headers.Cookie=this.cookies.join("; "));const a=await this.axiosInstance(n);return this.updateCookies(a.headers),a}async login(e,t){try{let r=await this.makeRequest("GET","https://mon-espace.izly.fr/Home/Logon",null,{Referer:"https://mon-espace.izly.fr/"});const i=n.load(r.data)('input[name="__RequestVerificationToken"]').val();if(r=await this.makeRequest("POST","https://mon-espace.izly.fr/Home/Logon",`__RequestVerificationToken=${encodeURIComponent(i)}&ReturnUrl=&Username=${encodeURIComponent(e)}&Password=${encodeURIComponent(t)}`,{"Content-Type":"application/x-www-form-urlencoded",Origin:"https://mon-espace.izly.fr",Referer:"https://mon-espace.izly.fr/Home/Logon"}),302===r.status){const e=r.headers.location;r=await this.makeRequest("GET",`https://mon-espace.izly.fr${e}`,null,{Referer:"https://mon-espace.izly.fr/Home/Logon"})}if(r=await this.makeRequest("GET","https://mon-espace.izly.fr/",null,{Referer:"https://mon-espace.izly.fr/Home/Logon"}),200!==r.status)throw new Error("Failed to login");return!0}catch(e){return console.error("Login error:",e.message),!1}}getAxiosInstance(){return this.axiosInstance}},l=class{loginService;axiosInstance;loggedIn=!1;constructor(){this.loginService=new c,this.axiosInstance=this.loginService.getAxiosInstance()}async login(e,t){try{return this.loggedIn=await this.loginService.login(e,t),this.loggedIn}catch(e){return console.error("Login error:",e.message),!1}}checkLogin(){if(!this.loggedIn)throw new Error("Not logged in. Please login first.")}async getProfile(){return this.checkLogin(),async function(e){try{const t=await e.get("https://mon-espace.izly.fr/Profile",{headers:{Referer:"https://mon-espace.izly.fr/"}});if(200===t.status){const e=n.load(t.data);return{name:e("h1").first().text().trim(),identifier:e(".heading-label-value").eq(0).text().trim(),pseudo:e(".heading-label-value").eq(1).text().trim(),birthDate:e(".heading-label-value").eq(2).text().trim(),address:e(".addWay").text().trim()+", "+e(".addZipCode").text().trim()+" "+e(".addCity").text().trim(),primaryEmail:e(".rectangle").eq(1).text().trim(),secondaryEmail:e("#emailPersonnel").text().trim(),phoneNumber:e("#currentPhoneNumber").text().trim(),companyCode:e(".rectangle").eq(4).text().trim(),tariffCode:e(".rectangle").eq(5).text().trim(),crousRightsEndDate:e(".rectangle").eq(6).text().trim()}}throw new Error("Failed to retrieve profile information")}catch(e){throw console.error("Error retrieving profile information:",e.message),e}}(this.axiosInstance)}async getNotifications(){return this.checkLogin(),async function(e){try{const t=await e.get("https://mon-espace.izly.fr/Profile?page=1",{headers:{Accept:"text/html, */*; q=0.01","X-Requested-With":"XMLHttpRequest",Referer:"https://mon-espace.izly.fr/Profile"}});if(200===t.status){const e=n.load(t.data),r=[];return e(".table-responsive .table tr").each(((t,i)=>{const n=e(i),a=s(n.find("td:nth-child(2)").text().trim()," à "),o=n.find("td:nth-child(3)").text().trim();r.push({date:a,description:o})})),r}throw new Error("Failed to retrieve notifications")}catch(e){throw console.error("Error retrieving notifications:",e.message),e}}(this.axiosInstance)}async getBalance(){return this.checkLogin(),async function(e){const t=await e.get("https://mon-espace.izly.fr/",{headers:{Referer:"https://mon-espace.izly.fr/Home/Logon"}}),r=n.load(t.data),i=o(r("#balance").text().trim()),a=s(r(".balance-heading-date").text().trim()," à ");if(isNaN(i))throw new Error("Failed to extract balance. Possible page structure change.");return{date:a,amount:i}}(this.axiosInstance)}async getDeposits(){return this.checkLogin(),async function(e){const t=await e.get("https://mon-espace.izly.fr/Home/GetTopups",{headers:{Referer:"https://mon-espace.izly.fr/","X-Requested-With":"XMLHttpRequest"}}),r=[],i=n.load(t.data);return i(".list-group-item").each(((e,t)=>{const n=i(t),a=n.find(".operation-type").text().split(" - ")[0]?.trim(),c=n.find(".operation-type").text().split(" - ")[1]?.trim(),l=s(n.find(".oeration-date").text().trim()," "),h=o(n.find(".operation-amount").text().trim()),p=n.find(".badge").text().trim();r.push({type:a,method:c,date:l,amount:h,status:p})})),r}(this.axiosInstance)}async generateQRCode(){return this.checkLogin(),async function(e,t=1){try{const r=await e.post("https://mon-espace.izly.fr/Home/CreateQrCodeImg",`numberOfQrCodes=${t}`,{headers:{Accept:"text/html, */*; q=0.01","X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Origin:"https://mon-espace.izly.fr",Referer:"https://mon-espace.izly.fr/Home/GenerateQRCode"}});if(200===r.status)return r.data;throw new Error("Failed to generate QR Code(s)")}catch(e){throw console.error("Error generating QR Code(s):",e.message),e}}(this.axiosInstance)}};module.exports=l;//# sourceMappingURL=index.js.map